# Throne of Legacy (王国の再建) - 全体設計・テクニカル仕様書

このドキュメントは、UEFN (Verse) プロジェクト『Throne of Legacy』のすべての設計思想と技術的要件を定義するマスタードキュメントである。

## 1. プロジェクト・ビジョン

プレイヤーは滅びた王国の唯一の継承者となり、廃墟となった玉座の間から再建を始める。
「ボタンを押して施設が増える快感（タイクーン）」と「自分のキャラクターが強くなる成長感（RPG）」、そして「毎回異なる冒険が楽しめる深み（ローグライク）」を一つの体験に統合する。

### コアコンセプト

- **タイクーン要素**: ボタンを押して施設が増える快感
- **RPG要素**: キャラクターが強くなる成長感
- **ローグライク要素**: 毎回異なる冒険が楽しめる深み

## 2. コア・システム設計 (Technical Architecture)

### 2.1 経済システム (Economy System)

#### 通貨単位
- **ゴールド (Gold)**: 基本通貨単位

#### 獲得ソース
- **玉座エリア（Mutator Zone）での滞在時間報酬**
  - プレイヤーが玉座エリアに滞在している間、一定時間ごとにゴールドを獲得
  - 滞在時間に応じた報酬レートを設定可能
  
- **敵（Creature）討伐時のドロップ報酬**
  - 敵を倒すとゴールドを獲得
  - 敵の種類やレベルに応じて報酬量が変動

#### 実装要件
- プレイヤーごとに `int` 型の変数を `player_data` クラスで管理
- 浮動小数点誤差を避けるため、内部数値はすべて整数（Integer）で処理する
- ゴールドの増減は必ず整数値で計算・保存

### 2.2 建設・アンロックシステム (Building System)

#### トリガー
- **Conditional Button デバイス**（ゴールド確認用）
  - ボタンを押すと、所持ゴールドを確認
  - 必要ゴールドを所持している場合のみ購入可能

#### ビジュアル
- **Prop Manipulator** または外部 Verse クラスからの `Show()` / `Hide()` 制御
  - 建築物は初期状態で非表示（Hidden）
  - 購入時に `Show()` で表示
  - 必要に応じてアニメーションやVFXを追加

#### 依存関係ロジック
- 「鍛冶屋」が建っていないと「武器のアップグレード」ボタンは出現しない等のフラグ管理
- 各施設には `required_buildings` 配列を設定
- 依存施設がすべて建設済みの場合のみ、次の施設がアンロックされる

#### 施設例
- **玉座の間**: 初期から利用可能、ゴールド生成の中心
- **鍛冶屋**: 武器のアップグレード機能をアンロック
- **魔法研究所**: 魔法アイテムの作成機能をアンロック
- **訓練場**: プレイヤーのステータス強化機能をアンロック

### 2.3 RPG・戦闘システム (Combat System)

#### クラス (Class)

##### 騎士 (Knight)
- **特徴**: 近接特化、高HP
- **初期ステータス**:
  - HP: 高
  - 攻撃力: 中
  - 防御力: 高
  - 移動速度: 低

##### 魔術師 (Mage)
- **特徴**: 遠距離魔法、低HP
- **初期ステータス**:
  - HP: 低
  - 攻撃力: 高
  - 防御力: 低
  - 移動速度: 中

##### 狩人 (Hunter)
- **特徴**: 弓・トラップ、高機動力
- **初期ステータス**:
  - HP: 中
  - 攻撃力: 中
  - 防御力: 中
  - 移動速度: 高

#### 成長要素

##### XP（経験値）システム
- 敵を倒すごとに `Amount * (1 + LevelMultiplier)` の経験値を付与
- レベルアップに必要な経験値は、現在のレベルに応じて増加
- 経験値は `player_data` クラスで管理

##### レベルアップ処理
- レベルアップ時に最大HPを動的に補正する処理
- レベルに応じたステータスボーナスを付与
- レベルアップ時にはVFXとサウンドでフィードバック

##### ステータス管理
- **HP**: 現在HP / 最大HP
- **レベル**: 現在のプレイヤーレベル
- **経験値**: 現在の経験値 / 次のレベルに必要な経験値

### 2.4 ローグライク・ダンジョン (Dungeon System)

#### エリア構成
- **城（安全地帯）**: 初期エリア、建設・アップグレードが可能
- **呪われた森（戦闘エリア）**: テレポートで移動、敵が出現

#### テレポートシステム
- 城から呪われた森へのテレポート機能
- 呪われた森から城への帰還機能
- テレポート時にはVFXを表示

#### ランダムバフシステム
- **クリア時に3枚のカード（Verse UI）を提示**
  - 攻撃力+20%
  - 移動速度UP
  - 撃破時HP回復
  - その他のランダムバフ

- **選択されたバフは、そのセッション（またはダンジョン攻略中）のみ有効**
- バフは `player_data` クラスで管理
- ダンジョンクリア時にバフをリセット

#### 敵ウェーブ制御
- ダンジョン内で敵が段階的に出現
- ウェーブごとに敵の種類や数が変化
- すべての敵を倒すと次のウェーブが開始

## 3. データ永続化 (Persistence Layer)

### セーブ対象
- **所持ゴールド**: プレイヤーが所持しているゴールドの量
- **現在のプレイヤーレベル**: プレイヤーの現在のレベル
- **アンロック済みの施設フラグ**: 建設済みの施設のリスト
- **選択したクラス**: プレイヤーが選択したクラス（Knight/Mage/Hunter）
- **獲得したバフ**: 現在有効なバフのリスト（セッション限定）

### 実装方法
- **`weak_map(player, player_data)` を使用**
  - プレイヤーごとのデータを管理
  - プレイヤーが接続している間、データを保持

- **`persistence` モジュールを活用**
  - プレイヤーが島を離れても進捗を維持
  - 次回接続時にデータを復元

### データ構造
```verse
player_data := class:
    var gold : int = 0
    var level : int = 1
    var experience : int = 0
    var max_hp : int = 100
    var current_hp : int = 100
    var player_class : int = 0  # 0: Knight, 1: Mage, 2: Hunter
    var unlocked_buildings : []int = []
    var active_buffs : []buff_data = []
```

## 4. 開発フェーズ・ロードマップ

### Phase 1: 王室の財政
**開発目標**: 自動ゴールド生成、基本HUDの実装

**具体的なVerseタスク**:
- [ ] プレイヤーデータ管理クラス (`player_data`) の作成
- [ ] Mutator Zoneでの滞在時間報酬システムの実装
- [ ] ゴールド表示用のHUD実装
- [ ] ゴールド獲得時のVFX/サウンド実装

### Phase 2: 国土の復興
**開発目標**: ボタン購入システム、建築物の表示/非表示制御

**具体的なVerseタスク**:
- [ ] Conditional Buttonとの連携システム
- [ ] ゴールド消費処理の実装
- [ ] Prop Manipulatorを使った建築物の表示/非表示制御
- [ ] 施設の依存関係ロジック実装
- [ ] 購入時のVFX/サウンド実装

### Phase 3: 騎士の目覚め
**開発目標**: クラス選択、レベルアップ、アイテム付与

**具体的なVerseタスク**:
- [ ] クラス選択UIの実装
- [ ] クラスごとのステータス設定
- [ ] 経験値獲得システムの実装
- [ ] レベルアップ処理の実装
- [ ] HP管理システムの実装
- [ ] レベルアップ時のVFX/サウンド実装

### Phase 4: 外界への遠征
**開発目標**: ダンジョン転送、敵ウェーブ制御、ランダム報酬

**具体的なVerseタスク**:
- [ ] テレポートシステムの実装
- [ ] ダンジョンエリアの設定
- [ ] 敵生成システムの実装
- [ ] ウェーブ制御システムの実装
- [ ] ランダムバフカードUIの実装
- [ ] バフ適用システムの実装

### Phase 5: 永続する王国
**開発目標**: セーブ機能の実装、独自のVerse UIメニュー構築

**具体的なVerseタスク**:
- [ ] persistenceモジュールを使ったセーブ機能実装
- [ ] データ読み込み処理の実装
- [ ] メインメニューUIの実装
- [ ] 設定メニューUIの実装
- [ ] 日本語フォント・UI対応

## 5. デザインガイドライン (Visual & UX)

### 世界観
- **ダーク・ファンタジー**: 松明の揺らめく光と、不気味な霧の演出
- **廃墟の王国**: かつて栄えた王国の残骸から再建を始める
- **雰囲気**: 暗く、神秘的で、希望の光が差し込む世界

### UIデザイン
- **日本語対応**: すべてのUIテキストを日本語で表示
- **フォント**: 視認性の高いフォントを選択
- **色使い**: 
  - **金（ゴールド）**: #FFD700 - 通貨、価値のあるもの
  - **赤（HP）**: #FF0000 - 体力、危険
  - **青（マナ/経験値）**: #0080FF - 魔法、経験値
  - **緑**: #00FF00 - 回復、成功
  - **紫**: #8000FF - 魔法、神秘的なもの

### フィードバック
- **購入時**: 紙吹雪VFX、光柱VFX、成功サウンド
- **レベルアップ時**: 光のエフェクト、祝福のサウンド
- **敵撃破時**: 爆発VFX、獲得ゴールド表示
- **ダメージ時**: 画面の揺れ、赤いフラッシュ

## 6. 技術仕様 (Technical Specifications)

### Verse言語の使用モジュール
- `/Fortnite.com/Devices` - デバイス制御
- `/Verse.org/Simulation` - シミュレーション機能
- `/UnrealEngine.com/Temporary/Diagnostics` - デバッグ機能
- `/Verse.org/Collections` - コレクション操作
- `/Verse.org/Math` - 数学計算

### パフォーマンス要件
- プレイヤー数: 最大16人（マッチメイキング設定に準拠）
- フレームレート: 60FPSを維持
- メモリ使用量: 効率的なデータ構造を使用

### エラーハンドリング
- すべての重要な操作にはエラーチェックを実装
- デバッグ用のPrint文を適切に配置
- 予期しない動作に対するフォールバック処理

## 7. 運用指示

### コード生成時の原則
1. **設計思想の優先**: コードを生成する際は、常にこの `docs/throne_of_legacy_gdd.md` の設計思想を優先すること
2. **モジュール性**: モジュール性を高め、拡張しやすいクリーンなコードを書くこと
3. **既存システムとの整合性**: 新しい機能を提案する際は、既存のコアループ（内政・建設・冒険）を損なわないか検討すること

### コーディング規約
- クラス名は `snake_case` を使用（例: `player_data`, `building_system`）
- 変数名は `snake_case` を使用
- 定数は `UPPER_SNAKE_CASE` を使用
- 関数名は `PascalCase` を使用（例: `OnBegin`, `CalculateGoldReward`）

### ドキュメント化
- すべての公開関数にはコメントを記述
- 複雑なロジックには説明コメントを追加
- 変更履歴は `docs/DEVELOPMENT_LOG.md` に記録

## 8. 参考資料

- [Epic Games UEFN Documentation](https://dev.epicgames.com/documentation/en-us/uefn)
- [Verse Language Reference](https://dev.epicgames.com/documentation/en-us/uefn/verse-language-reference-in-unreal-editor-for-fortnite)
- [Verse API Reference](https://dev.epicgames.com/documentation/en-us/uefn/verse-api-reference)
